<%content_for :head do%>
  <%=javascript_include_tag "ui/external/cookie/jquery.cookie.js"%>
  <%=javascript_include_tag "ui/external/dynatree/jquery.dynatree.js"%>
  <%=stylesheet_link_tag "/javascripts/ui/external/dynatree/skin/ui.dynatree.css"%>
  <style>
    div.ui-dynatree-container{
      border: none;
      overflow: auto;
      height: 130px;
      font-size: 9pt;
    }
  </style>
  <script type='text/javascript'>
    function updateSelectRegion(select, willSelected, level){
      var selecteds = $("#netloc").val();
      if(selecteds == ""){
        selecteds = []
      }else{
        selecteds = selecteds.split(" or ");
      }
      if(select){
        willSelected = level + "=" + willSelected;
        if($.inArray(willSelected, selecteds) == -1){
          selecteds.push(willSelected);
          $("#netloc").val(selecteds.join(" or "));
        }
      }else{
        var newSelecteds = $.grep(selecteds, function(n,i){
          return n == level + "=" + willSelected;
        }, true);
        $("#netloc").val(newSelecteds.join(" or "));
      }
    }
    function updateSelectRegionCN(select, willSelected, level){
      if($("#netloc_cns").length == 0)
        return ; 
      var selecteds = $("#netloc_cns").val();
      if(selecteds == ""){
        selecteds = []
      }else{
        selecteds = selecteds.split(",");
      }
      if(select){
        if($.inArray(willSelected, selecteds) == -1){
          selecteds.push(willSelected);
          $("#netloc_cns").val(selecteds.join(","));
        }
      }else{
        var newSelecteds = $.grep(selecteds, function(n,i){
          return n == willSelected;
        }, true);
        $("#netloc_cns").val(newSelecteds.join(","));
      }
    }
    $(function(){
      $("#tree").dynatree({
        checkbox: true,
        selectMode: 2,
        imagePath: '',
        autoFocus: false,
        strings: {
          loading: "加载中…",
          loadError: "加载错误!"
        },
        initAjax:{
          data:{parent: -1,
            netloc: "<%=  @perf_template.netloc_original %>"
          },
          url: "/report/perf_templates/domains"
        },
        onActivate: function(dtnode) {
        },
        onLazyRead: function(dtnode){
          dtnode.appendAjax({
            url: "/report/perf_templates/domains",
            data:{
              parent : dtnode.data.key,
              level : dtnode.data.level,
              netloc: "<%=  @perf_template.netloc_original %>"
            }
          })
        },
        onSelect: function(select, dtnode) {
          var willSelected = dtnode.data.key;
          var level = dtnode.data.level_desc;
          updateSelectRegion (select, willSelected, level);
          updateSelectRegionCN(select, dtnode.data.title, level)
        },
        strings: {
          loading: "加载中…",
          loadError: "加载错误!"
        },
        onDblClick: function(dtnode, event) {
          dtnode.toggleSelect();
        },
        onKeydown: function(dtnode, event) {
          if( event.which == 32 ) {
            dtnode.toggleSelect();
            return false;
          }
        }
      });
    });
  </script>
<%end%>
<div style="width:100%;height:145px;" id="tree"></div>