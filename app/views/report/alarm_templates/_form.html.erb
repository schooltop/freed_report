<% content_for :head do %>
  <style type="text/css">
    .form .col{
      width:48%;
    }
    .form .label{
      width:10.3%;
    }
    .form .text{
      width: 87%;
    }
    .form .col .label{
      width:20.5%;
    }
    .form .col .text{
      width: 70%;
    }
    .form .col .select{
      width: 72%;
    }
    .category-option{
      display : none;
    }
    select{
      height: 21px;
      vertical-align:middle;
    }
    #tree {
      height: 270px !important ;
    }
    div.ui-dynatree-container{
      height: 270px !important;
    }
  </style>
  <script type="text/javascript">
    function checkDicGroup(){
      var checkedGroups = "<%=@perf_template.dic_group.is_a?(Array) ? @perf_template.dic_group.uniq.join(",") : @perf_template.dic_group%>".split(",");
      $.each(checkedGroups, function(i, group){
        if(group != "")
          $("input[value=" + group + "]").attr("checked", true).click().attr("checked", true);
      });
    }

    function checkChartSet(){
      var chart_sets = "<%=chart_set_seqs.join(",")%>".split(",");
      $.each(chart_sets, function(i, chart_set){
        $("input[chart_name=chart" + chart_set + "]").attr("checked", true).click().attr("checked", true);
      });
    }

    function changeCndidateByTimeGran(){
      var timeGran = $("#time_gran option:selected").val();
      var availableTimeGran = [];
      $(".gran-effect option[type=time-gran]").remove();
      $(".x_axis option[type=time-gran]").remove();
      if( timeGran == '0'){
        availableTimeGran[0] = "<option type='time-gran' value='年份'>年份</options>";
        availableTimeGran[1] = "<option type='time-gran' value='季度'>季度</options>";
      }else if(timeGran == '1'){
        availableTimeGran[0] = "<option type='time-gran' value='年份'>年份</options>";
        availableTimeGran[1] = "<option type='time-gran' value='月份'>月份</options>";
      }else if(timeGran == '2'){
        availableTimeGran[0] = "<option type='time-gran' value='年份'>年份</options>";
        availableTimeGran[1] = "<option type='time-gran' value='周'>周</options>";
      }else if(timeGran == '3'){
        availableTimeGran[0] = "<option type='time-gran' value='日期'>日期</options>";
      }else if(timeGran == '4'){
        availableTimeGran[0] = "<option type='time-gran' value='日期'>日期</options>";
        availableTimeGran[1] = "<option type='time-gran' value='时段'>时段</options>";
      }
      $(".candidate").append(availableTimeGran.join(""));
      $(".x_axis").append(availableTimeGran.join(""));
    }

    function changeCandidateByNetGran(){
      var netlocGran = $("#netloc_gran option:selected").text();
      $(".gran-effect option[type=netloc-gran]").remove();
      $(".x_axis option[type=netloc-gran]").remove();
      if(netlocGran == '') return ;
      var selectNetlocGran = "<option type='netloc-gran' value='"+netlocGran +"'>"+netlocGran+"</options>" ;
      $(".candidate").append(selectNetlocGran);
      $(".x_axis").append(selectNetlocGran);
    }

    function adjustGroupCol(){
      var chart_sets = window.eval('<%=@perf_template.chart_sets.to_json%>');
      $.each(chart_sets, function(i, chart_set){
        var chart = $("#chart" + chart_set.chart_seq + "-xcol");
        var groupColCandidate = $("#chart" + chart_set.chart_seq + "-candidate");
        var groupSelectedCol = $("#chart" + chart_set.chart_seq + "-selected");
        chart.attr("value", chart_set.x_col);
        groupColCandidate.find("option[value=" + chart_set.x_col + "]").remove();
        if(chart_set.group_col){
          if(!(chart_set.group_col instanceof Array))
            chart_set.group_col = chart_set.group_col.split(",");
          $.each(chart_set.group_col, function(i, col){
            groupColCandidate.find("option[value=" + col + "]").appendTo(groupSelectedCol.get()).attr("selected", true);
          });
        }
      })
    }
    function cancelUsers(){
      $("#alarm_template_report_template_users option").attr("selected", false);
    }

    $(function(){
      $(".cancelusers").click(function(e){
        cancelUsers();
      });
      $("#time_gran").change(function(e){
        //对横轴，分组 添加值
        changeCndidateByTimeGran();
      });
      $("#netloc_gran").change(function(e){
        //对横轴，分组 添加值
        changeCandidateByNetGran();
      });

      $(".netloc-effect").click(function(e){
        //对横轴，分组 添加值
        var e = $(e.target);
        if(e.attr("checked") == true){
          var option = "<option type='netloc-effect' value='" + e.attr("col_value") + "'>" + e.attr("col_value") + "</option>";
          $(".candidate").append(option);
          $(".x_axis").append(option);
        }else{
          $(".candidate option[value=" + e.attr("col_value")+ "]").remove();
          $(".x_axis option[value=" + e.attr("col_value")+ "]").remove();
        }
      });

      $(".chart-enabled").click(function(e){
        //对图表的可操作设置
        var self = $(this);
        $("."+self.attr('chart_name')).attr('disabled',!self.attr("checked"));
      })

      $(".x_axis").change(function(e){
        //对分组值的过滤 还原
        var self = $(this);
        var except = self.attr("except");
        var oldValue = self.attr('old_value');
        var newValue = self.val();
        if (oldValue && oldValue != newValue){
          var optionType = $("." + except + "_x_axis option[value=" + oldValue + "]").attr('type');
          var option = "<option type='" + optionType + "' value='" + oldValue + "'>" + oldValue + "</option>";
          $("#" + except + "-candidate").append(option);
        }
        self.attr('old_value',newValue);
        $("." + except + "-except option[value=" + newValue + "]").remove();
      });

      $(".mover").click(function(e){
        //分组移动
        e = $(e.target);
        var direct = e.attr("direct");
        var candidate = e.attr("candidate");
        var selected = e.attr("selected");
        if(direct == "right"){
          var selectedOptions = $("#" + candidate + " option:selected");
          $.each(selectedOptions, function(i, option){
            $("#" + selected).append(option);
          })
        }else{
          var selectedOptions = $("#" + selected + " option:selected");
          $.each(selectedOptions, function(i, option){
            $("#" + candidate).append(option);
          })
        }
      });

      //初始图表设置
      $(".chart,.chart1,.chart2,.chart3").attr("disabled", true);

      //初始dic_group选择
      checkDicGroup();

      //初始chart_set选择
      checkChartSet();

      //初始对横轴，分组 添加值
      changeCndidateByTimeGran();

      //初始对横轴，分组 添加值
      changeCandidateByNetGran();

      //对横轴加值，分组减值，数据库的值从待选移动到被选
      adjustGroupCol();
    })
  </script>
<% end %>

<% form_for :alarm_template, @perf_template, :url => url, :html => {:method => method, :class => 'form ui-widget'} do |f| -%>
  <input type="hidden" name="alarm_template[report_type]" value="2">
  <%= ui_error f.error_messages unless f.error_messages.empty? %>
  <% field_set_tag '', :style => "padding: 1em;", :class => "ui-widget-content ui-corner-all" do %>
    <div class='wrap'>
      <div class='li'>
        <%=f.label 'report_name', '模板名称', :required=>true %>
        <%=f.text_field 'report_name' %>
      </div>

      <div class='li'>
        <div class='left col'>
          <%=f.label 'time_gran','时间粒度',:class=>'label', :required => true %>
          <%=f.select :time_gran, time_grans.delete_if {|x| x[1] == 6}, {}, {:id => "time_gran"}%>
        </div>
        <div class='left col' style="margin-left:10px;">
          <%=f.label 'netloc_gran','区域粒度',:class=>'label', :required => true %>
          <%=f.select :netloc_gran, [['省份',0],['地市',1], ['郊县',2], ['热点',5]], {}, {:id => "netloc_gran"}%>
        </div>
      </div>

      <div class='li'>
        <div class='left col'>
          <% field_set_tag '模板用户<a style="cursor: hand;" class="cancelusers">(不选择用户)</a>', :style => "padding: 5px;height:100px;", :class => "ui-widget-content ui-corner-all" do %>
            <%=f.select :report_template_users, @all_users.map{|user| [user.name, user.id]}, {:selected => @perf_template.report_template_users.collect{|user|user.user_id}},  {:multiple => true, :style => "height:80px;width:95%;margin-left:2.5%;border:none;"}%>
          <%end%>
        </div>
        <div class="left col" style="margin-left:10px;">
          <% field_set_tag '分类选项', :style => "padding: 5px;height:100px;", :class => "ui-widget-content ui-corner-all" do %>
            <%[['device_manu','设备厂家'],['sender_class','设备类型'],['port_type','热点类型'],['device_type','设备型号'],['alarm_type','告警类型'],['severity_name','告警级别'],['alarm_alias','告警名称']].each do |item|%>
              <div style="width:48%;float:left;">
                <%=check_box_tag 'alarm_template[dic_group][]',item[0], false,:id=>item[0],:class=>"netloc-effect",:col_value=>item[1]%>
                <%=label_tag item[0], item[1] %>
              </div>
            <%end%>
          <%end%>
        </div>
      </div>

      <div class="li">
        <div class="left col">
          <% field_set_tag '统计范围', :style => "padding: 5px;height:287px;", :class => "ui-widget-content ui-corner-all" do %>
            <%=render :partial=>'report/domain_selection'%>
            <input type="hidden" value="<%=net_loc%>" name="alarm_template[netloc]" id="netloc" >
          <%end%>
        </div>
        <div class="left col" style="margin-left:10px;">
          <fieldset style="padding: 5px;" class="ui-widget-content ui-corner-all">
            <%chart1_set = chart_set(1) || {}%>
            <legend>
              <%=check_box_tag :chart1_enabled,"",false, :chart_name => "chart1", :class=>" chart-enabled"%>
              <%=label_tag "chart1_enabled", "图表一设置"%>
            </legend>
            <div class="chart chart1">
              <%=hidden_field_tag "alarm_template[chart_sets][][chart_seq]" ,1,:class=>'chart1'%>
              <div class="li">
                <%=label_tag 'alarm_template[chart_sets][][chart_name]','图表名称:',:class=>'label'%>
                <%=text_field_tag 'alarm_template[chart_sets][][chart_name]', chart1_set.chart_name, :style => "width:58%",:class => " chart1"%>
              </div>
              <div class="li">
                <%=label_tag 'alarm_template[chart_sets][][chart_type]','图表类型:',:class=>'label'%>
                <%=select_tag 'alarm_template[chart_sets][][chart_type]', options_for_select(Rms::ReportTemplateCandidate.report_type_candidates, chart1_set.chart_type.to_i ), {:style=>"width:60%",:class => " chart1"}%>
              </div>
              <div class="li">
                <%=label_tag 'alarm_template[chart_sets][][x_col]','图表横轴:',:class=>'label'%>
                <%=select_tag 'alarm_template[chart_sets][][x_col]', options_for_select([["", ""]]), {:id => "chart1-xcol",:style=>"width:199px;", :except =>"chart1", :class => " chart1 x_axis chart1_x_axis"}%>
              </div>
              <div class="li">
                <fieldset style="padding: 5px;width:40%;" class="ui-widget-content ui-corner-all col left">
                  <legend>可选分组属性</legend>
                  <%=select_tag 'chart1_candidate', [], {:multiple => true, :id=>"chart1-candidate", :class =>" chart1 chart1-except candidate gran-effect", :style => "height:100px;width:130px;border:none;"}%>
                </fieldset>
                <div class="col left" style="width:20px;height:100px;margin-top:5px;text-align:center;">
                  <%=image_tag "right.gif", :style => "margin-top: 40px;cursor:pointer;", :class=>"mover", :direct=>"right", :candidate => "chart1-candidate", :selected => "chart1-selected"%>
                  <%=image_tag "left.gif", :style => "margin-top: 20px;cursor:pointer;", :class=>"mover", :direct=>"left", :candidate => "chart1-candidate", :selected => "chart1-selected"%>
                </div>
                <fieldset style="padding: 5px;width:40%;" class="ui-widget-content ui-corner-all col left">
                  <legend>可选分组属性</legend>
                  <%=select_tag 'alarm_template[chart_sets][][group_col]', [],  {:multiple => true, :id => "chart1-selected",  :class => " chart1 chart1-except selected gran-effect", :style => "height:100px;width:95%;border:none;"}%>
                </fieldset>
              </div>
            </div>
          </fieldset>
        </div>
      </div>

      <div class="li">
        <div class="left col">
          <fieldset style="padding: 5px;" class="ui-widget-content ui-corner-all">
            <%chart2_set = chart_set(2) || {} %>
            <legend>
              <%=check_box_tag :chart2_enabled,"",false, :chart_name => "chart2", :class=>" chart-enabled"%>
              <%=label_tag "chart2_enabled", "图表二设置"%>
            </legend>
            <div class="chart chart2">
              <%=hidden_field_tag "alarm_template[chart_sets][][chart_seq]" ,2, :class=>'chart2'%>
              <div class="li">
                <%=label_tag 'alarm_template[chart_sets][][chart_name]','图表名称:',:class=>'label'%>
                <%=text_field_tag 'alarm_template[chart_sets][][chart_name]', chart2_set.chart_name, :style => "width:58%" ,:class => " chart2"%>
              </div>
              <div class="li">
                <%=label_tag 'alarm_template[chart_sets][][chart_type]','图表类型:',:class=>'label'%>
                <%=select_tag 'alarm_template[chart_sets][][chart_type]', options_for_select(Rms::ReportTemplateCandidate.report_type_candidates, chart2_set.chart_type.to_i ), {:style=>"width:60%",:class => " chart2"}%>
              </div>
              <div class="li">
                <%=label_tag 'alarm_template[chart_sets][][x_col]','图表横轴:',:class=>'label'%>
                <%=select_tag 'alarm_template[chart_sets][][x_col]', options_for_select([["", ""]]), {:id => "chart2-xcol",:style=>"width:199px;", :except =>"chart2", :class => " chart2 x_axis chart2_x_axis"}%>
              </div>
              <div class="li">
                <fieldset style="padding: 5px;width:40%;" class="ui-widget-content ui-corner-all col left">
                  <legend>可选分组属性</legend>
                  <%=select_tag :chart2_candidate, [],  {:multiple => true, :id=>"chart2-candidate", :disabled=>true, :class =>" chart2 chart2-except candidate gran-effect", :style => "height:100px;width:130px;border:none;"}%>
                </fieldset>
                <div class="col left" style="width:20px;height:100px;margin-top:5px;text-align:center;">
                  <%=image_tag "right.gif", :style => "margin-top: 40px;cursor:pointer;", :class=>"mover", :direct=>"right", :candidate => "chart2-candidate", :selected => "chart2-selected"%>
                  <%=image_tag "left.gif", :style => "margin-top: 20px;cursor:pointer;", :class=>"mover", :direct=>"left", :candidate => "chart2-candidate", :selected => "chart2-selected"%>
                </div>
                <fieldset style="padding: 5px;width:40%;" class="ui-widget-content ui-corner-all col left">
                  <legend>已选分组属性</legend>
                  <%=select_tag 'alarm_template[chart_sets][][group_col]', [], {:multiple => true, :id => "chart2-selected", :disabled=>true, :class => " chart2 chart2-except selected gran-effect", :style => "height:100px;width:95%;border:none;"}%>
                </fieldset>
              </div>
            </div>
          </fieldset>
        </div>
        <div class="left col" style="margin-left:10px;">
          <fieldset style="padding: 5px;" class="ui-widget-content ui-corner-all">
            <%chart3_set = chart_set(3) || {} %>
            <legend>
              <%=check_box_tag :chart3_enabled,"",false, :chart_name => "chart3", :class=>" chart-enabled"%>
              <%=label_tag "chart3_enabled", "图表三设置"%>
            </legend>
            <div class="chart chart3">
              <%=hidden_field_tag "alarm_template[chart_sets][][chart_seq]" ,3,:class=>'chart3'%>
              <div class="li">
                <%=label_tag 'alarm_template[chart_sets][][chart_name]','图表名称:',:class=>'label'%>
                <%=text_field_tag 'alarm_template[chart_sets][][chart_name]', chart3_set.chart_name, :style => "width:58%",:class => " chart3"%>
              </div>
              <div class="li">
                <%=label_tag 'alarm_template[chart_sets][][chart_type]','图表类型:',:class=>'label'%>
                <%=select_tag 'alarm_template[chart_sets][][chart_type]', options_for_select(Rms::ReportTemplateCandidate.report_type_candidates, chart3_set.chart_type.to_i ), {:style=>"width:60%",:class => " chart3"}%>
              </div>
              <div class="li">
                <%=label_tag 'alarm_template[chart_sets][][x_col]','图表横轴:',:class=>'label'%>
                <%=select_tag 'alarm_template[chart_sets][][x_col]', options_for_select([["", ""]]), {:id => "chart3-xcol",:style=>"width:199px;", :except =>"chart3", :class => " chart3 x_axis chart3_x_axis"}%>
              </div>
              <div class="li">
                <fieldset style="padding: 5px;width:40%;" class="ui-widget-content ui-corner-all col left">
                  <legend>可选分组属性</legend>
                  <%=select_tag :chart3_candidate, [],  {:multiple => true, :id=>"chart3-candidate", :disabled=>true, :class =>" chart3 chart3-except candidate gran-effect", :style => "height:100px;width:130px;border:none;"}%>
                </fieldset>
                <div class="col left" style="width:20px;height:100px;margin-top:5px;text-align:center;">
                  <%=image_tag "right.gif", :style => "margin-top: 40px;cursor:pointer;", :class=>"mover", :direct=>"right", :candidate => "chart3-candidate", :selected => "chart3-selected"%>
                  <%=image_tag "left.gif", :style => "margin-top: 20px;cursor:pointer;", :class=>"mover", :direct=>"left", :candidate => "chart3-candidate", :selected => "chart3-selected"%>
                </div>
                <fieldset style="padding: 5px;width:40%;" class="ui-widget-content ui-corner-all col left">
                  <legend>已选分组属性</legend>
                  <%=select_tag 'alarm_template[chart_sets][][group_col]', [], {:multiple => true, :id => "chart3-selected", :disabled=>true, :class => " chart3 chart3-except selected gran-effect", :style => "height:100px;width:95%;border:none;"}%>
                </fieldset>
              </div>
            </div>
          </fieldset>
        </div>
      </div>

      <div class='li' align="center">
        <%= f.submit "确定", :name => nil %>
        <%= link_button_to "取消", :action => 'index' %>
      </div>

    </div>
  <%end%>
<%end%>

