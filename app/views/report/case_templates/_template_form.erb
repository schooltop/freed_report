<style type="text/css">
  .form .col{
      width:48%;
    }
    .form .label{
      width:10.3%;
    }
    .form .text{
      width: 87%;
    }
    .form .col .label{
      width:20.8%;
    }
    .form .col .text{
      width: 70%;
    }
    .form .col .select{
      width: 72%;
    }
  .category-option{
    display : none;
  }
  select{
    height: 21px;
    vertical-align:middle;
  }
</style>
<script type="text/javascript">
  function changeIndex(timeGran){
    $("#kiplist").empty();
    $(".topn-index").empty();
    $("#kiplist").append("<option value=''>加载中...</option>");
    $.getJSON("/report/perf_templates/kpilist_candidate", { netgran: timeGran}, function(grans){
      $("#kiplist").empty();
      var selectedKpilists = "<%=@perf_template.kpilist.is_a?(Array) ? @perf_template.kpilist.join(",") : @perf_template.kpilist%>".split(",");
      for(var i=0; i<grans.length; i++){
        var gran = grans[i];
        var selected = $.inArray(gran.id + "", selectedKpilists);
        var option = ["<option value='" + gran.id + "'"];
        if(selected != -1)
          option.push(" selected='selected'");
        option.push(">" + gran.name + "</option>");
        $("#kiplist").append(option.join(""));
      }
      $("#kiplist").change();
      $("#topnkpi option[value=" + "<%=@perf_template.topn_kpi%>]").attr("selected", true);
    });
  }
  function changeCandidateByNetGran(){
    $(".selected").empty();
    $(".candidate option[type=region-effect]").remove();
    $(".x_axis option[type=region-effect]").remove();
    var selectedOption = $("#region_gran option:selected")[0];
    if(selectedOption.value != 0){
      var option = "<option type='region-effect' value='" + selectedOption.text + "'>" + selectedOption.text + "</option>";
      $(".candidate").append(option);
      $(".x_axis").append(option);
    }
  }
  function checkDicGroup(){
    var checkedGroups = "<%=@perf_template.dic_group.is_a?(Array) ? @perf_template.dic_group.uniq.join(",") : @perf_template.dic_group%>".split(",");
    $.each(checkedGroups, function(i, group){
      if(group != "")
        $("input[value=" + group + "]").attr("checked", true).click().attr("checked", true);
    });
  }
  function checkTopn(){
    var topn = <%=@perf_template.is_topn.nil? ? 0 : @perf_template.is_topn%>;
    if(topn == 1){
      $("#topn-enabled").attr("checked", true).click().attr("checked", true);
    }
  }
  function checkChartSet(){
    var chart_sets = "<%=chart_set_seqs.join(",")%>".split(",");
    $.each(chart_sets, function(i, chart_set){
      $("input[chart_name=chart" + chart_set + "]").attr("checked", true).click().attr("checked", true);
    });
  }
  function adjustGroupCol(){
    var chart_sets = window.eval('<%=@perf_template.chart_sets.to_json%>');
    $.each(chart_sets, function(i, chart_set){
      var chart = $("#chart" + chart_set.chart_seq + "-xcol");
      var groupColCandidate = $("#chart" + chart_set.chart_seq + "-candidate");
      var groupSelectedCol = $("#chart" + chart_set.chart_seq + "-selected");
      chart.attr("value", chart_set.x_col);
      groupColCandidate.find("option[value=" + chart_set.x_col + "]").remove();
      if(chart_set.group_col){
        if(!(chart_set.group_col instanceof Array))
          chart_set.group_col = chart_set.group_col.split(",");
        $.each(chart_set.group_col, function(i, col){
          groupColCandidate.find("option[value=" + col + "]").appendTo(groupSelectedCol.get()).attr("selected", true);
        });
      }
    })
  }
  function cancelUsers(){
    $("#perf_template_report_template_users option").attr("selected", false);
  }
  $(function(){
    $(".all_time").click(function(e){
      $(".time_gran").attr("checked", $(e.target).attr("checked"));
    });
      $(".cancelusers").click(function(e){
        cancelUsers();
      });
      $("#region_gran").change(function(e){
        changeCandidateByNetGran();
        $(".region-effect").attr("checked", false);
      })
      $(".region-effect").click(function(e){
        var e = $(e.target);
        if(e.attr("checked") == true){
          var option = "<option type='region-effect' value='" + e.attr("col_value") + "'>" + e.attr("col_value") + "</option>";
          $(".candidate").append(option);
          $(".x_axis").append(option);
        }else{
          $(".candidate option[value=" + e.attr("col_value")+ "]").remove();
          $(".x_axis option[value=" + e.attr("col_value")+ "]").remove();
        }
      });
      $(".chart-enabled").click(function(e){
        var e = $(e.target);
        var chartEnabledEffect = e.attr("chart_name");
        $("."+chartEnabledEffect).attr("disabled", !e.attr("checked"));
      });
      $(".mover").click(function(e){
        e = $(e.target);
        var direct = e.attr("direct");
        var candidate = e.attr("candidate");
        var selected = e.attr("selected");
        if(direct == "right"){
          var selectedOptions = $("#" + candidate + " option:selected");
          $.each(selectedOptions, function(i, option){
            $("#" + selected).append(option);
          })
        }else{
          var selectedOptions = $("#" + selected + " option:selected");
          $.each(selectedOptions, function(i, option){
            $("#" + candidate).append(option);
          })
        }
      });
      $(".x_axis").change(function(e){
        e = $(e.target);
        var except = e.attr("except");
        $("." + except + "-except option[value=" + e.val() + "]").remove();
        $("#" + except + "-candidate").empty();
        var selected = $("#" + except + "-selected option");
        $.each(e.children(), function(i, option){
          if(option.value != e.val() && option.value != ""){
            var notInSelected = true;
            $.each(selected, function(i, option1){
              if(option.value == option1.value){
                notInSelected = false;
                return;
              }
            })
            if(notInSelected)
              $("#" + except + "-candidate").append($(option).clone());
          }
        });
      });
      changeIndex(-1);
      $(".chart,.chart1,.chart2,.chart3,.topn").attr("disabled", true);
    })
</script>
<% form_for :perf_template, @perf_template, :url => url, :html => {:method => method, :class => 'form ui-widget'} do |f|%>
  <input type="hidden" name="perf_template[report_type]" value="3">
  <% field_set_tag '', :style => "padding: 1em;", :class => "ui-widget-content ui-corner-all" do %>
    <%= ui_error f.error_messages unless f.error_messages.empty? %>
    <div class='wrap'>
      <div class='li'>
        <%=f.label :report_name, '模板名称', :required=>true %>
        <%=f.text_field :report_name %>
      </div>
      <div class='li'>
        <div class='left col'>
          <% field_set_tag '统计时段', :style => "padding: 5px;height:150px;", :class => "ui-widget-content ui-corner-all" do %>
            <div style="width:65px;float:left;white-space:nowrap;">
              <%=check_box_tag "all_time", "", false, :style => "float:left", :class=>" all_time"%>
              <%=label_tag "all_time", "全部", :class =>"label", :style => "float:left;width:30px;"%>
            </div>
            <%(1..24).each do |i|%>
              <div style="width:65px;float:left;">
                <%=check_box_tag "perf_template[hourlist][]", i , @perf_template.hourlist.nil? ?  false : @perf_template.hourlist.split(',').include?(i.to_s), :id =>"hourlist_#{i}", :class => "time_gran", :style => "float:left;"%>
                <%=label_tag "hourlist_#{i}", i.to_s, :class=>"label", :style => "float:left;width:30px;"%>
              </div>
            <%end%>
          <%end%>
        </div>
        <div class='left col' style="margin-left:10px;">
          <% field_set_tag '统计范围', :style => "padding: 5px;height:150px;", :class => "ui-widget-content ui-corner-all" do %>
            <%=render :partial=>'report/case_selection'%>
          <%end%>
          <input type="hidden" value="<%=net_loc%>" name="perf_template[netloc]" id="netloc" >
        </div>
      </div>
      <div class='li'>
        <div class='left col'>
          <%=f.label :time_gran,'时间粒度',:class=>'label', :required => true %>
          <%=f.select :time_gran, time_grans.delete_if {|x| x[1] == 6}, {:selected => @perf_template.time_gran.to_i}, {:id => "time_gran"}%>
        </div>
        <div class='left col' style="margin-left:10px;">
          <%=f.label :busytime,'忙时选项',:class=>'label', :required => true %>
          <%=f.select :busytime, [["全时段",-2],["全网忙时", -1],["指定时段",-3]], {}, {:id => "busy_time"}%>
        </div>
        <script type="text/javascript">
            function timeGranChanged(timeGran){
              var availableTimeGran = [];
              $(".time-gran-effect option[type=time-gran]").remove();
              $(".x_axis option[type=time-gran]").remove();
              $(".selected").empty();
              if(timeGran == 0){
                availableTimeGran[0] = "<option type='time-gran' value='年份'>年份</options>";
                availableTimeGran[1] = "<option type='time-gran' value='季度'>季度</options>";
              }else if(timeGran == 1){
                availableTimeGran[0] = "<option type='time-gran' value='年份'>年份</options>";
                availableTimeGran[1] = "<option type='time-gran' value='月份'>月份</options>";
              }else if(timeGran == 2){
                availableTimeGran[0] = "<option type='time-gran' value='年份'>年份</options>";
                availableTimeGran[1] = "<option type='time-gran' value='周'>周</options>";
              }else if(timeGran == 3){
                availableTimeGran[0] = "<option type='time-gran' value='日期'>日期</options>";
              }else if(timeGran == 4){
                availableTimeGran[0] = "<option type='time-gran' value='日期'>日期</options>";
                availableTimeGran[1] = "<option type='time-gran' value='时段'>时段</options>";
              }
              $(".candidate").append(availableTimeGran.join(""));
              $(".x_axis").append(availableTimeGran.join(""));
            }
            $(function(){
              $("#time_gran").change(function(e){
                var timeGran = $("#time_gran option:selected").val();
                timeGranChanged(timeGran)
              });
              timeGranChanged($("#time_gran option:selected").val());
            })
        </script>
      </div>
      <div class='li'>
        <div class='left col'>
          <%=f.label 'netloc_gran','专案粒度',:class=>'label', :required => true %>
          <%=f.select :netloc_gran, [["全部", 0],["专案", 1],["AP",2]], {}, {:id => "region_gran"}%>
        </div>
        <div class='left col' style="margin-left: 10px;">
          <%=f.label 'dic_group','分组选项',:class=>'label left' %>
          <div class="left">
            <div style="float:left;white-space:nowrap;">
              <input id="sw_vendor_enabled" type="checkbox" class="region-effect" col_value="设备厂家" value="device_manu" name="perf_template[dic_group][]" style="float:left">
              <label for="sw_vendor_enabled" style="float:left" class="label">设备厂家</label>
            </div>
            <div style="float:left;white-space:nowrap;">
              <input id="sw_mode_enabled" type="checkbox" class="region-effect" col_value="设备型号" value="device_type" name="perf_template[dic_group][]" style="float:left">
              <label for="sw_mode_enabled" style="float:left" class="label">设备型号</label>
            </div>
          </div>
        </div>
      </div>
      <div class='li'>
        <div class='left col'>
          <% field_set_tag '模板用户<a style="cursor: hand;" class="cancelusers">(不选择用户)</a>', :style => "padding: 5px;height:150px;", :class => "ui-widget-content ui-corner-all" do %>
            <%=f.select :report_template_users, @all_users.map{|user| [user.name, user.id]}, {:selected => @perf_template.report_template_users.collect{|user|user.user_id}},  {:multiple => true, :style => "height:130px;width:95%;margin-left:2.5%;border:none;"}%>
          <%end%>
        </div>
        <div class='left col' style="margin-left:10px;">
          <% field_set_tag '统计指标<a  style="cursor: hand;" onclick="countall();" class="countall">(全选)</a>', :style => "padding: 5px;height:150px;", :class => "ui-widget-content ui-corner-all" do %>
            <%=f.select :kpilist, "", [], :multiple => true, :style => "height:130px;width:300px;margin-left:2.5%;border:none;", :id =>"kiplist"%>
          <%end%>
          <script type="text/javascript">
              $(function(){
                $("#kiplist").change(function(e){
                  var selectedIndexes = $("#kiplist option:selected");
                  $(".topn-index").empty();
                  $.each(selectedIndexes, function(i, index){
                    $(".topn-index").append("<option value='" + index.text + "'>" + index.text + "</option>");
                  });
                });
              })
          </script>
        </div>
      </div>
      <div class='li'>
        <div class='left col'>
          <fieldset style="padding: 5px;height:290px;" class="ui-widget-content ui-corner-all">
            <legend>
              <%=f.check_box :is_topn, :id => "topn-enabled", :class => " topon_enabled"%>
              <%=label_tag :is_topn, "支持TopN", :for =>"topn-enabled"%>
            </legend>
            <div style="margin:5px;" class="topn">
              <div class="li">
                <%=f.label :topn_kpi,'TopN指标', :class=>'label'%>
                <%=f.select :topn_kpi, [],{}, {:style=>"width:200px;", :id => "topnkpi", :class => " topn topn-index"}%>
              </div>
              <div class="li">
                <%=f.label :sort_type,'排序方式',:class=>'label'%>
                <%=f.select :sort_type, [['升序', 1], ['降序', 2]],{:selected => @perf_template.sort_type}, {:style=>"width:200px",:class=>" topn"}%>
              </div>
              <div class="li">
                <%=f.label :top_n,'TopN值',:class=>'label'%>
                <%=f.text_field :top_n, :style=>"width:193px;",:class=>' topn'%>
              </div>
            </div>
            <script type="text/javascript">
                $(function(){
                  $(".topon_enabled").click(function(e){
                    $(".topn").attr("disabled", !$(e.target).attr("checked"));
                  })
                })
            </script>
          </fieldset>
        </div>
        <div class='left col' style="margin-left:10px;">
          <fieldset style="padding: 5px;" class="ui-widget-content ui-corner-all">
            <%chart1_set = chart_set(1).nil? ? {} : chart_set(1)%>
            <legend>
              <%=check_box_tag :chart1_enabled, "", false, :chart_name => "chart1", :class=>" chart-enabled"%>
              <%=label_tag :chart1_enabled, "图表一设置"%>
            </legend>
            <div class="chart1 chart">
              <input type="hidden" name="perf_template[chart_sets][][chart_seq]" value="1">
              <div class="li">
                <%=label_tag "perf_template[chart_sets][][chart_name]",'图表名称:',:class=>'label'%>
                <%=text_field_tag "perf_template[chart_sets][][chart_name]", chart1_set.chart_name, :style => "width:58%",:class=>" chart1"%>
              </div>
              <div class="li">
                <%=label_tag "perf_template[chart_sets][][chart_type]",'图表类型:',:class=>'label'%>
                <%=select_tag "perf_template[chart_sets][][chart_type]", options_for_select(Rms::ReportTemplateCandidate.report_type_candidates, chart1_set.chart_type.nil? ? nil : chart1_set.chart_type.to_i), { :style=>"width:60%",:class=>" chart1"}%>
              </div>
              <div class="li">
                <%=label_tag "perf_template[chart_sets][][x_col]",'图表横轴:',:class=>'label'%>
                <%=select_tag "perf_template[chart_sets][][x_col]", options_for_select([["", ""]]), {:id => "chart1-xcol", :style=>"width:199px;", :except =>"chart1", :class => " chart1 x_axis chart1_x_axis"}%>
              </div>
              <div class="li">
                <fieldset style="padding: 5px;width:40%;" class="ui-widget-content ui-corner-all col left">
                  <legend>可选分组属性</legend>
                  <%=select_tag "chart1_candidate", [], {:multiple => true, :id=>"chart1-candidate", :class =>" chart1 chart1-except candidate time-gran-effect", :style => "height:100px;width:130px;border:none;"}%>
                </fieldset>
                <div class="col left" style="width:20px;height:100px;margin-top:5px;text-align:center;">
                  <%=image_tag "right.gif", :style => "margin-top: 40px;cursor:pointer;", :class=>"mover", :direct=>"right", :candidate => "chart1-candidate", :selected => "chart1-selected"%>
                  <%=image_tag "left.gif", :style => "margin-top: 20px;cursor:pointer;", :class=>"mover", :direct=>"left", :candidate => "chart1-candidate", :selected => "chart1-selected"%>
                </div>
                <fieldset style="padding: 5px;width:40%;" class="ui-widget-content ui-corner-all col left">
                  <legend>已选分组属性</legend>
                  <%=select_tag "perf_template[chart_sets][][group_col]", chart1_set.group_col, {:multiple => true, :id => "chart1-selected", :class => " chart1 chart1-except selected time-gran-effect", :style => "height:100px;width:95%;border:none;"}%>
                </fieldset>
              </div>
            </div>
          </fieldset>
        </div>
      </div>
      <div class='li'>
        <div class='left col'>
          <fieldset style="padding: 5px;" class="ui-widget-content ui-corner-all">
            <%chart2_set = chart_set(2).nil? ? {} : chart_set(2)%>
            <legend>
              <%=check_box_tag :chart2_enabled, "",false, :chart_name => "chart2", :class=>" chart-enabled"%>
              <%=label_tag :chart2_enabled, "图表二设置"%>
            </legend>
            <div class="chart2 chart">
              <input type="hidden" name="perf_template[chart_sets][][chart_seq]" value="2" class="chart2">
              <div class="li">
                <%=label_tag "perf_template[chart_sets][][chart_name]",'图表名称:',:class=>'label'%>
                <%=text_field_tag "perf_template[chart_sets][][chart_name]", chart2_set.chart_name, :style => "width:58%",:class=>' chart2'%>
              </div>
              <div class="li">
                <%=label_tag "perf_template[chart_sets][][chart_type]",'图表类型:',:class=>'label'%>
                <%=select_tag "perf_template[chart_sets][][chart_type]", options_for_select(Rms::ReportTemplateCandidate.report_type_candidates, chart2_set.chart_type.nil? ? nil : chart2_set.chart_type.to_i),{:style=>"width:60%",:class=>' chart2'}%>
              </div>
              <div class="li">
                <%=label_tag "perf_template[chart_sets][][x_col]",'图表横轴:',:class=>'label'%>
                <%=select_tag "perf_template[chart_sets][][x_col]", options_for_select([["", ""]]), {:id => "chart2-xcol", :style=>"width:199px;", :except =>"chart2", :disabled=>true, :class => " chart2 chart2 x_axis chart2_x_axis"}%>
              </div>
              <div class="li">
                <fieldset style="padding: 5px;width:40%;" class="ui-widget-content ui-corner-all col left">
                  <legend>可选分组属性</legend>
                  <%=select_tag :chart1_candidate, [], {:multiple => true, :id=>"chart2-candidate", :class =>" chart2 chart2-except candidate time-gran-effect", :style => "height:100px;width:130px;border:none;"}%>
                </fieldset>
                <div class="col left" style="width:20px;height:100px;margin-top:5px;text-align:center;">
                  <%=image_tag "right.gif", :style => "margin-top: 40px;cursor:pointer;", :class=>"mover", :direct=>"right", :candidate => "chart2-candidate", :selected => "chart2-selected"%>
                  <%=image_tag "left.gif", :style => "margin-top: 20px;cursor:pointer;", :class=>"mover", :direct=>"left", :candidate => "chart2-candidate", :selected => "chart2-selected"%>
                </div>
                <fieldset style="padding: 5px;width:40%;" class="ui-widget-content ui-corner-all col left">
                  <legend>已选分组属性</legend>
                  <%=select_tag "perf_template[chart_sets][][group_col]", [],{:multiple => true, :id => "chart2-selected", :class => " chart2 chart2-except selected time-gran-effect", :style => "height:100px;width:95%;border:none;"}%>
                </fieldset>
              </div>
            </div>
          </fieldset>
        </div>
        <div class='left col' style="margin-left:10px;">
          <fieldset style="padding: 5px;" class="ui-widget-content ui-corner-all">
            <%chart3_set = chart_set(3).nil? ? {} : chart_set(3)%>
            <legend>
              <%=check_box_tag :chart3_enabled, "",false, :chart_name => "chart3", :class=>" chart-enabled"%>
              <%=label_tag :chart3_enabled, "图表三设置"%>
            </legend>
            <div class="chart3 chart">
              <input type="hidden" name="perf_template[chart_sets][][chart_seq]" value="3" class="chart3">
              <div class="li">
                <%=label_tag "perf_template[chart_sets][][chart_name]",'图表名称:',:class=>'label'%>
                <%=text_field_tag "perf_template[chart_sets][][chart_name]", chart3_set.chart_name, :style => "width:58%",:class=>' chart3'%>
              </div>
              <div class="li">
                <%=label_tag "perf_template[chart_sets][][chart_type]",'图表类型:',:class=>'label'%>
                <%=select_tag "perf_template[chart_sets][][chart_type]", options_for_select(Rms::ReportTemplateCandidate.report_type_candidates, chart3_set.chart_type.nil? ? nil : chart3_set.chart_type.to_i),{:style=>"width:60%",:class=>' chart3'}%>
              </div>
              <div class="li">
                <%=label_tag "perf_template[chart_sets][][x_col]",'图表横轴:',:class=>'label'%>
                <%=select_tag "perf_template[chart_sets][][x_col]", options_for_select([["", ""]]),{:id => "chart3-xcol", :style=>"width:199px;", :except =>"chart3", :class => " chart3 x_axis chart3_x_axis"}%>
              </div>
              <div class="li">
                <fieldset style="padding: 5px;width:40%;" class="ui-widget-content ui-corner-all col left">
                  <legend>可选分组属性</legend>
                  <%=select_tag :chart3_candidate, [], {:multiple => true, :id=>"chart3-candidate",:class =>" chart3 chart3-except candidate time-gran-effect", :style => "height:100px;width:130px;border:none;"}%>
                </fieldset>
                <div class="col left" style="width:20px;height:100px;margin-top:5px;text-align:center;">
                  <%=image_tag "right.gif", :style => "margin-top: 40px;cursor:pointer;", :class=>"mover", :direct=>"right", :candidate => "chart3-candidate", :selected => "chart3-selected"%>
                  <%=image_tag "left.gif", :style => "margin-top: 20px;cursor:pointer;", :class=>"mover", :direct=>"left", :candidate => "chart3-candidate", :selected => "chart3-selected"%>
                </div>
                <fieldset style="padding: 5px;width:40%;" class="ui-widget-content ui-corner-all col left">
                  <legend>已选分组属性</legend>
                  <%=select_tag "perf_template[chart_sets][][group_col]", [],{:multiple => true, :id => "chart3-selected", :class => " chart3 chart3-except selected time-gran-effect", :style => "height:100px;width:95%;border:none;"}%>
                </fieldset>
              </div>
            </div>
          </fieldset>
        </div>
      </div>
      <div class='li' align="center">
        <%= f.submit "确定", :name => nil %>
        <%= link_button_to "取消", :action => 'index' %>
      </div>
    </div>
  <%end%>
<%end%>
<script type="text/javascript">
    $(function(){
      checkDicGroup();
      checkTopn();
      checkChartSet();
      adjustGroupCol();
    });
</script>
