<% content_for :head do %>
  <%= stylesheet_link_tag "ui/ui/ui.datepicker.css" %>
  <%= javascript_include_tag "ui/ui/i18n/ui.datepicker-zh-CN.js" %>
  <%= javascript_include_tag "ui/ui/ui.datepicker.js" %>
  <%=javascript_include_tag 'ui/external/cluetip/jquery.cluetip' %>
  <%=javascript_include_tag 'ui/external/cluetip/jquery.hoverIntent.js' %>
  <%=javascript_include_tag 'ui/external/bgiframe/jquery.bgiframe.min'%>
  <%=javascript_include_tag 'ui/ui/jquery.multiSelect'%>
  <%=stylesheet_link_tag '/javascripts/ui/external/cluetip/jquery.cluetip.css',:media=>'all' %>
  <%=javascript_include_tag "ui/external/cookie/jquery.cookie.js"%>
  <%=javascript_include_tag "ui/external/dynatree/jquery.dynatree.js"%>
  <%=stylesheet_link_tag 'ui/ui/jquery.multiSelect'%>
  <%=stylesheet_link_tag "/javascripts/ui/external/dynatree/skin/ui.dynatree.css"%>
  <%=stylesheet_link_tag "ui/ui/ui.datepicker.css" %>
  <%= javascript_include_tag "ui/ui/i18n/ui.datepicker-zh-CN.js"%>
  <%= javascript_include_tag "ui/ui/ui.datepicker.js"%>
  <style type="text/css">
    .ui-grid-scrollable TABLE{
      width:100%;
    }
  </style>
    <script type="text/javascript">
    function conditionChanged(ev){
      var current_value = ev.target.value;
      var el = $(ev.target);
      var original_value = el.attr('original_value');
      var all_guide = $('.control .all_guide');
      if(original_value != current_value){
        el.addClass("changed");
        all_guide.attr("disabled", true);
        el.attr("title", "当前属性已经改变，必须重新查询");
        all_guide.addClass("ui-state-disabled");
      }else{
        el.removeClass("changed");
        all_guide.attr("disabled", false);
        el.attr("title", "");
        all_guide.removeClass("ui-state-disabled");
      }
    }

    $(function(){
      <%#*$("#region-condition").submit(function(e){%>
        <%#*$("#submit").val("分析中").attr("disabled", true);%>
      <%#*});%>
      $("#begin_time").datepicker($.extend({}, $.datepicker.regional["zh-CN"], {
        showStatus: true
      }));
      $(".control input[type=text],select").change(conditionChanged);

      //纬度分析
      var defSelect = $('.time_range').attr("value");
      if(defSelect == 3){
        $('.advanced').hide();
        $("#dataSelect").show();
      }
      else if(defSelect == 2){
        $('.advanced').show();
        $(".advanced #week").show();
        $("#dataSelect").hide();
        loadTime();
      }
      else if(defSelect == 1){
        $('.advanced').show();
        $(".advanced #week").hide();
        loadTime();
        $(".advanced #week input:checked").attr("checked", false);
      }
      else{
        $('.advanced').hide();
        $("#dataSelect").hide();
      }
      $('.time_range').change(function(item){
        var select = item.target.value;
        if(select == 1 || select == 2){
          $('.advanced').slideDown();
          $(".advanced input:checked").attr("checked", "");
          $("#dataSelect").slideUp();
          loadTime();
          if(select == 2){
            $(".advanced #week").show();
          }
          else{
            $(".advanced #week").hide();
            $(".advanced #week input:checked").attr("checked", false);
          }
        }
        else if(select == 3){
          $('.advanced').slideUp();
          $("#dataSelect").slideDown();
        }
        else {
          $('.advanced').slideUp();
          $("#dataSelect").slideUp();
        }
      });
      function loadTime(){
  <% unless params[:year].nil? %>
        $("#year").find("input[value=<%= params[:year] %>]").attr("checked", true);
  <% end %>
  <% unless params[:month].nil? %>
        $("#month").find("input[value=<%= params[:month] %>]").attr("checked", true);
  <% end %>
    };
  });
  </script>
  <script type="text/javascript">
    function customRange(input){
      return {
        minDate: (input.id == "end_time" ? $("#begin_time").datepicker("getDate") : null),
        maxDate: (input.id == "begin_time" ? $("#end_time").datepicker("getDate") : null)
      };
    }
    function resizeTable(){
      var height = document.documentElement.clientHeight;
      var top=$(".ui-grid-scroll-body").offset().top;
      height = height - top - 30;
      $(".ui-grid-scroll-body").css("height", height);
    }
    $(function(){
      $("#begin_time,#end_time").datepicker($.extend({}, $.datepicker.regional["zh-CN"], {
        showStatus: true,
        beforeShow: customRange
      }));
      resizeTable();
    });
  </script>
<%end %>
<%content_for :header_title do %>
  全省WLAN业务AP性能统计报表(月报)
<%end %>
<div>
 <%form_tag(url_for(:action=>'wlan_ap_pref_month'), :method => "get", :method=>"get") do %>
    <div id="control" class="control clearfix">
      <span style="float:left;margin-right:5px;margin-left:5px;margin-top:3px;"><%=new_time_range%></span>
      <span style="float:left;margin-right:5px;"><%=hidden_field_tag :saved_time_range_text, params[:saved_time_range_text]%></span>
      <span style="float:left;margin-right:5px;"><%=hidden_field_tag :saved_time_range_value, params[:saved_time_range_value]%></span>

      <span style="float:left;margin-left:2px;"><%=submit_tag '确定',:name=>nil, :id => "submit"%></span>
      
      <ul class="ul export-box f5">
        <li>
          <%= export_to 'csv', "CSV", params %>
        </li>
      </ul>
           <div id="dataSelect" style="display:none">
      <%field_set_tag "自定义时间范围", :class => "ui-widget-content ui-corner-all" do %>
        <%=begin_time %>
        <%#=end_time %>
      <%end%>
    </div>
    </div>
  <%end %>
  <%
  sort_url = params.merge({:page => nil})
%>
   <div id="showdata" class="form">
    <% ui_grid_for @grid,:scrollable =>true do |g,cols,data|%>
    <%g.head do %>
      <%g.r do%>
                   <%= g.format_sort(:sampledate,"统计时间", :html => {:width => 125}, :url =>sort_url) %>
                   <%= g.format_sort(:nodecn,"省份", :html => {:width => 125}, :url =>sort_url) %>
                   <%= g.format_sort(:ap_back,"AP退服率(%)", :html => {:width => 125}, :url =>sort_url) %>
                   <%= g.format_sort(:assocsucc_rate,"关联成功率(%)", :html => {:width => 125}, :url =>sort_url) %>
                   <%= g.format_sort(:rxbytes_rate,"上行平均速率(Mbps/s)", :html => {:width => 125}, :url =>sort_url) %>
                   <%= g.format_sort(:rxbytes_max_rate,"上行峰值速率(Mbps/s)", :html => {:width => 125}, :url =>sort_url) %>
                   <%= g.format_sort(:txbytes_rate,"下行平均速率(Mbps/s)", :html => {:width => 125}, :url =>sort_url) %>
                   <%= g.format_sort(:txbytes_max_rate,"下行峰值速率(Mbps/s)", :html => {:width => 125}, :url =>sort_url) %>
                   <%= g.format_sort(:userdown_rate,"单用户平均下载速率(Mbps/s)", :html => {:width => 125}, :url =>sort_url) %>
                   <%= g.format_sort(:userdown_max_rate,"单用户峰值下载速率(Mbps/s)", :html => {:width => 125}, :url =>sort_url) %>
                   <%= g.format_sort(:abnormaldrops_rate,"关联终端异常掉线率(%)", :html => {:width => 125}, :url =>sort_url) %>
                   <%= g.format_sort(:busyap_rate,"超忙AP占比(%)", :html => {:width => 125}, :url =>sort_url) %>
                   <%= g.format_sort(:idleap_rate,"超闲AP占比(%)", :html => {:width => 125}, :url =>sort_url) %>
                   <%= g.format_sort(:refused_rate,"AP关联拥塞率(%)", :html => {:width => 125}, :url =>sort_url) %>
    <%end%>
   <%end%>
    <%g.body do%>
      <% if data.size >0 %>
        <% data.each do |d| %>
          <% g.r do %>
                    <%=g.d d[:sampledate].nil? ? "":d[:sampledate].strftime("%Y-%m-%d")%>
                    <%=g.d d[:nodecn]%>
                    <%=g.d d[:ap_back]%>
                    <%=g.d d[:assocsucc_rate]%>
                    <%=g.d d[:rxbytes_rate]%>
                    <%=g.d d[:rxbytes_max_rate].to_i%>
                    <%=g.d d[:txbytes_rate]%>
                    <%=g.d d[:txbytes_max_rate].to_i%>
                    <%=g.d d[:userdown_rate].to_i%>
                    <%=g.d d[:userdown_max_rate].to_i%>
                    <%=g.d d[:abnormaldrops_rate]%>
                    <%=g.d d[:busyap_rate]%>
                    <%=g.d d[:idleap_rate]%>
                    <%=g.d d[:refused_rate]%>
            <%end%>
        <% end %>
      <%else%>
        <%g.r do%>
          <td colspan="<%= 2+cols.size %>">当前没有数据。</td>
        <%end%>
      <%end%>
    <%end%>
  <%end%>
</div>
</div>
  <%= bottom_show @ap_pref_month_data %>
